<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yamb of the Balkan - Divine Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="capacitor.js"></script> 
    
    <style>
        /* --- THEME ENGINE --- */
        :root {
            --bg-base: #121212; 
            --bg-gradient-1: #2a2a2a; --bg-gradient-2: #050505;
            --gold-main: #E0C995; --gold-glow: rgba(224, 201, 149, 0.3);
            --text-main: #F0F0F0; --text-muted: #a0a0a0;
            --glass-bg: rgba(255, 255, 255, 0.04); 
            --glass-panel: rgba(30, 32, 35, 0.60);
            --glass-border: 1px solid rgba(224, 201, 149, 0.2); 
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.45);
            --dice-bg: linear-gradient(145deg, #353535, #222222); 
            --dice-border: rgba(224, 201, 149, 0.3);
            --dice-color: #d0d0d0; --dice-active: #fff;
            --grid-cell-bg: rgba(255, 255, 255, 0.02); 
            --grid-header-bg: rgba(224, 201, 149, 0.1); 
            --input-bg: #252525; --input-border: #444;
            --danger: #ff5252; --success: #66BB6A;
            --col-nadole: #81D4FA; --col-nagore: #EF9A9A; --col-sredina: #FFCC80; 
            --col-rucno: #CE93D8; --col-najava: #E0C995; --col-slobodna: #B0BEC5;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        body.light-theme {
            --bg-base: #e0e5ec; --bg-gradient-1: #f0f2f5; --bg-gradient-2: #cbd1d9;
            --gold-main: #b8962e; --gold-glow: rgba(184, 150, 46, 0.3);
            --text-main: #2c3e50; --text-muted: #5f6c7b;
            --glass-bg: rgba(0, 0, 0, 0.05); --glass-panel: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --dice-bg: linear-gradient(135deg, #ffffff, #e6e6e6); --dice-border: rgba(0,0,0,0.15);
            --dice-color: #777; --dice-active: #000;
            --grid-cell-bg: rgba(0,0,0,0.04); --grid-header-bg: rgba(0,0,0,0.08);
            --input-bg: #fff; --input-border: #ccc;
            --col-nadole: #0288d1; --col-nagore: #d32f2f; --col-sredina: #f57c00; 
            --col-rucno: #7b1fa2; --col-slobodna: #616161;
        }

        body.medium-theme {
            --bg-base: #4A148C; --bg-gradient-1: #7B1FA2; --bg-gradient-2: #FF6F00; 
            --gold-main: #FFD700; --gold-glow: rgba(255, 215, 0, 0.6);
            --text-main: #FFFFFF; --text-muted: #E1BEE7;
            --glass-bg: rgba(255, 255, 255, 0.15); --glass-panel: rgba(60, 10, 90, 0.75); 
            --glass-border: 1px solid rgba(255, 215, 0, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --dice-bg: linear-gradient(135deg, #FFECB3, #FFCA28); 
            --dice-border: rgba(255, 255, 255, 0.5);
            --dice-color: #BF360C; --dice-active: #000;
            --grid-cell-bg: rgba(255, 255, 255, 0.1); --grid-header-bg: rgba(0, 0, 0, 0.2);
            --input-bg: rgba(0, 0, 0, 0.3); --input-border: var(--gold-main);
            --col-nadole: #29B6F6; --col-nagore: #FF5252; --col-sredina: #FFA726; 
            --col-rucno: #E040FB; --col-najava: #FFD700; --col-slobodna: #BDBDBD;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-base);
            background-image: radial-gradient(circle at 50% 30%, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 80%);
            color: var(--text-main);
            /* KORISTIMO DVH za mobilne browsere */
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden;
            display: flex; justify-content: center;
            transition: background 0.5s, color 0.5s;
        }

        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.4s, transform 0.4s;
            transform: scale(0.95); z-index: 1; 
            padding-top: max(10px, var(--safe-top)); 
            padding-bottom: max(10px, var(--safe-bottom));
            padding-left: max(10px, var(--safe-left));
            padding-right: max(10px, var(--safe-right));
        }
        .screen.active { opacity: 1; visibility: visible; transform: scale(1); z-index: 10; }
        .hidden { display: none !important; }

        /* --- RESPONSIVNI MENU --- */
        #main-menu { overflow-y: auto; padding: 20px; }
        .menu-title { font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 5vh; text-align: center; line-height: 1.2; color: var(--text-main); text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .menu-subtitle { font-weight:300; font-size: 0.4em; color:var(--gold-main); display: block; letter-spacing: 2px; }
        
        .btn-menu {
            width: 100%; max-width: 350px; padding: 15px; margin: 1vh 0;
            background: var(--glass-bg); border: var(--glass-border); color: var(--text-main);
            font-size: clamp(0.9rem, 2vh, 1.1rem); 
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            border-radius: 50px; transition: all 0.2s; 
            font-family: 'Montserrat', sans-serif; font-weight: 600;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .btn-menu:active { transform: scale(0.95); }
        .btn-primary { border-color: var(--gold-main); color: var(--gold-main); background: rgba(224, 201, 149, 0.08); box-shadow: 0 0 15px rgba(224, 201, 149, 0.15); }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-resume { border-color: var(--success); color: var(--success); background: rgba(76, 175, 80, 0.1); box-shadow: 0 0 15px rgba(76, 175, 80, 0.2); font-weight: 700; }
        
        .menu-divider { margin: 10px 0; width: 50%; height: 1px; background: linear-gradient(90deg, transparent, var(--glass-border), transparent); }


        /* --- GAME LAYOUT & COMPACT VISIBILITY --- */
        #game-scene { 
            justify-content: flex-start; 
            padding: 0; 
            background: transparent; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        .game-header { 
            width: 100%; 
            padding: 8px 15px; 
            padding-top: max(8px, var(--safe-top));
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: var(--glass-border); 
            background: var(--glass-panel); 
            z-index: 20; 
            flex-shrink: 0; 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
        }
        
        .game-content { 
            display: flex; 
            width: 100%; 
            flex: 1; /* Zauzmi sav preostali prostor */
            overflow: hidden; 
            position: relative; 
            padding-bottom: var(--safe-bottom);
        }

        .left-panel { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%;
            overflow: hidden; 
        }
        
        /* --- TABLES AREA --- */
        .tables-wrapper { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            display: flex; 
            justify-content: center; 
            align-items: flex-start;
            padding: 2px; 
            -webkit-overflow-scrolling: touch;
        }

        .player-table { 
            width: 100%; 
            /* Maksimalna ≈°irina za tablete da ne bude pre≈°iroko, ali 98% na telefonu */
            max-width: 800px; 
            background: var(--glass-panel); 
            border-radius: 10px; 
            border: var(--glass-border); 
            padding: 2px; 
            backdrop-filter: blur(12px); 
            box-shadow: var(--glass-shadow); 
            margin-bottom: 5px;
        }
        
        .player-name { text-align: center; font-weight: 700; color: var(--gold-main); font-size: 0.9rem; margin: 3px 0; }
        
        .grid-container { 
            display: grid; 
            /* Prva kolona fleksibilna ali min 40px, ostale dele prostor jednako */
            grid-template-columns: minmax(40px, 1.3fr) repeat(6, 1fr); 
            gap: 1px; 
            width: 100%;
            /* Fluidni font: min 11px, max 16px zavisno od visine ekrana */
            font-size: clamp(11px, 1.6vh, 16px); 
        }
        
        .grid-cell { 
            /* KLJUƒåNO: Umesto aspect-ratio koristimo fluidnu visinu */
            height: clamp(26px, 4.2vh, 45px);
            display: flex; align-items: center; justify-content: center; 
            color: var(--text-muted); background: var(--grid-cell-bg); 
            overflow: hidden;
        }
        
        /* Sticky Headers za tabelu da se ne gube pri skrolu na malim ekranima */
        .col-header { position: sticky; top: 0; z-index: 5; font-weight: bold; background: var(--grid-header-bg); backdrop-filter: blur(5px); }
        
        .row-header { justify-content: flex-end; padding-right: 5px; font-weight: 600; font-size: 0.85em; text-transform: uppercase; white-space: nowrap; }
        .sum { color: var(--gold-main); font-weight: bold; }
        .c-nadole { color: var(--col-nadole); } .c-nagore { color: var(--col-nagore); } .c-sredina { color: var(--col-sredina); } .c-rucno { color: var(--col-rucno); } .c-najava { color: var(--col-najava); } .c-slobodna { color: var(--col-slobodna); }
        
        .score-btn { width: 100%; height: 100%; border: none; background: transparent; color: var(--text-main); font-weight: bold; cursor: pointer; font-size: inherit; padding: 0; }
        .score-btn.filled { color: var(--gold-main); font-weight: 700; text-shadow: 0 0 5px rgba(224, 201, 149, 0.3); }
        .highlight-najava { background: rgba(224, 201, 149, 0.25) !important; border: 1px solid var(--gold-main); box-shadow: inset 0 0 10px rgba(224, 201, 149, 0.2); }
        .total-score { font-size: 1.2rem; color: var(--gold-main); text-align: center; margin-top: 2px; font-weight: 800; }
        
        /* --- CONTROLS AREA (DICE) --- */
        .controls-area { 
            background: var(--glass-panel); 
            border-top: 1px solid var(--gold-main); 
            display: flex; 
            align-items: center; 
            padding: 5px 10px; 
            z-index: 50; 
            flex-shrink: 0; 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3); 
            /* Compact layout defaults */
            flex-direction: row; 
            justify-content: space-between;
            min-height: 12vh;
            max-height: 140px;
        }

        .dice-container { 
            display: flex; gap: 1vw; justify-content: center; flex-wrap: nowrap; 
        }
        
        .dice { 
            /* Kockice skaliraju u odnosu na manju dimenziju ekrana (vmin) */
            width: clamp(35px, 11vmin, 70px); 
            height: clamp(35px, 11vmin, 70px);            
            flex-shrink: 0;                 
            background: var(--dice-bg); 
            border: 1px solid var(--dice-border); 
            border-radius: 15%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: clamp(20px, 7vmin, 40px); 
            color: var(--dice-color); 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .dice.rolling { animation: roll 0.4s linear infinite; color: var(--gold-main); text-shadow: 0 0 10px var(--gold-glow); }
        .dice.held { border-color: var(--danger); color: var(--danger); transform: translateY(-5%); box-shadow: 0 0 10px rgba(255, 68, 68, 0.4); }
        @keyframes roll { 0% { transform: rotate(0deg) rotateX(0deg); } 25% { transform: rotate(90deg) rotateX(90deg); } 50% { transform: rotate(180deg) rotateX(180deg); } 75% { transform: rotate(270deg) rotateX(270deg); } 100% { transform: rotate(360deg) rotateX(360deg); } }

        .game-info { 
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; 
            margin-left: 10px; min-width: 100px;
        }
        .status-label { font-size: clamp(0.7rem, 2vmin, 1rem); color: var(--gold-main); font-weight: 600; margin-bottom: 5px; white-space: nowrap;}
        .action-btn-group { display: flex; flex-direction: column; gap: 5px; width: 100%; align-items: flex-end;}
        .game-btn { 
            padding: 8px 12px; border-radius: 20px; border: none; font-weight: bold; 
            font-size: clamp(0.7rem, 2vmin, 0.9rem); 
            text-transform: uppercase; white-space: nowrap; cursor: pointer; width: 100%;
        }
        .btn-throw { background: var(--gold-main); color: #000; box-shadow: 0 0 10px var(--gold-glow); transition: transform 0.1s; }
        .btn-throw:active { transform: scale(0.95); }
        .btn-secondary { background: var(--glass-bg); color: var(--text-main); border: var(--glass-border); }
        .btn-active-toggle { background: var(--danger); color: white; box-shadow: 0 0 10px rgba(255,0,0,0.4); }
        .btn-highlight { background: var(--gold-main) !important; color: black !important; }

        /* --- BREAKPOINTS: SPECIFIC OPTIMIZATION --- */

        /* 1. PORTRAIT PHONES (Default layout handled above, tweaking details) */
        @media (orientation: portrait) {
            .controls-area { flex-direction: column; gap: 10px; min-height: auto; padding-bottom: max(10px, var(--safe-bottom)); }
            .game-info { width: 100%; align-items: center; flex-direction: row; justify-content: space-between; margin-left: 0; }
            .action-btn-group { flex-direction: row; width: auto; gap: 10px; }
            .btn-throw { width: 100px; }
            .dice { width: 13vw; height: 13vw; max-width: 60px; max-height: 60px; font-size: 8vw; }
            .player-table { width: 98%; } /* Na telefonima koristi skoro celu ≈°irinu */
        }

        /* 2. TABLETS PORTRAIT (7-inch & 10-inch) - ≈†irina 600px do 1024px */
        @media (min-width: 600px) and (orientation: portrait) {
            .player-table { width: 90%; margin: 0 auto; }
            .grid-container { font-size: 1.8vh; gap: 2px; } 
            .grid-cell { height: 4vh; } /* Na tabletima malo vi≈°a polja */
            .dice { width: 8vh; height: 8vh; font-size: 4vh; }
            .controls-area { padding: 20px; gap: 20px;}
            .game-info { justify-content: center; gap: 20px; }
            .btn-throw { padding: 15px 40px; font-size: 1.2rem; width: auto; }
            .status-label { font-size: 1.2rem; }
        }

        /* 3. LANDSCAPE PHONES (Compact height) */
        @media (max-width: 900px) and (orientation: landscape) {
            .game-header { padding: 2px 15px; min-height: 35px; }
            .game-content { flex-direction: row; }
            .left-panel { flex-direction: row; }
            .tables-wrapper { width: 70%; padding: 5px; }
            .player-table { width: 100%; margin-bottom: 0; height: 100%; display: flex; flex-direction: column; }
            .grid-container { flex: 1; align-content: center; } /* Centriraj grid vertikalno */
            .grid-cell { height: auto; } /* Ovde neka auto jer je flex container */
            .controls-area { 
                width: 30%; height: 100%; border-top: none; border-left: 1px solid var(--gold-main); 
                flex-direction: column; justify-content: center; gap: 10px; padding: 5px;
            }
            .dice-container { flex-wrap: wrap; width: 100%; }
            .dice { width: 8vh; height: 8vh; font-size: 4vh; }
            .game-info { margin: 0; align-items: center; text-align: center; }
            .action-btn-group { flex-direction: column; width: 80%; }
        }

        /* 4. TABLETS LANDSCAPE (10-inch+) */
        @media (min-width: 901px) and (orientation: landscape) {
            .game-content { flex-direction: row; justify-content: center; padding: 20px; }
            .left-panel { max-width: 1200px; flex-direction: row; gap: 20px; }
            .tables-wrapper { flex: 2; height: 100%; align-items: center; }
            .controls-area { 
                flex: 1; height: auto; max-height: 500px; align-self: center;
                border: 1px solid var(--gold-main); border-radius: 15px; 
                flex-direction: column; justify-content: center; gap: 20px; padding: 30px;
            }
            .dice { width: 60px; height: 60px; font-size: 30px; }
            .grid-container { gap: 2px; }
            .grid-cell { height: 35px; font-size: 16px; }
        }

        /* Modals & Chat Misc */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .custom-modal { background: var(--glass-panel); padding: 30px; border-radius: 20px; border: 1px solid var(--gold-main); box-shadow: var(--glass-shadow); width: 90%; max-width: 400px; text-align: center; transform: scale(0.8); transition: 0.3s; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .modal-overlay.active .custom-modal { transform: scale(1); }
        .cm-title { color: var(--gold-main); font-size: 1.4rem; margin-bottom: 15px; font-weight: 700; text-transform: uppercase; }
        .cm-msg { color: var(--text-main); margin-bottom: 25px; line-height: 1.5; font-size: 1rem; }
        .cm-input { width: 100%; padding: 12px; margin-bottom: 20px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main); font-family: 'Montserrat'; font-size: 1rem; text-align: center; border-radius: 8px;}
        .cm-btn-group { display: flex; justify-content: center; gap: 10px; }
        .cm-btn { padding: 10px 25px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; flex: 1; }
        .cm-btn-ok { background: var(--gold-main); color: #000; box-shadow: 0 0 10px var(--gold-glow); }
        .cm-btn-cancel { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

        .chat-float-btn { position: fixed; bottom: 140px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--gold-main); color: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 1000; box-shadow: 0 0 15px var(--gold-glow); transition: transform 0.2s; }
        .chat-float-btn:hover { transform: scale(1.1); }
        .chat-notification { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; border: 2px solid #000; display: none; }
        .chat-notification.active { display: block; }
        .chat-window { position: fixed; bottom: 200px; right: 20px; width: 300px; height: 350px; background: var(--glass-panel); border: 1px solid var(--gold-main); border-radius: 15px; display: flex; flex-direction: column; z-index: 9999; opacity: 0; visibility: hidden; box-shadow: var(--glass-shadow); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .chat-window.active { opacity: 1; visibility: visible; }
        .chat-header { padding: 10px; background: rgba(255,255,255,0.05); border-bottom: var(--glass-border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--gold-main); font-size: 0.9rem; cursor: move; touch-action: none; }
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .chat-footer { padding: 10px; border-top: var(--glass-border); display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.2); }
        .btn-chat-send { flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; border:none; background: var(--gold-main); color: #000; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; line-height: 1.4; word-wrap: break-word; }
        .msg-incoming { align-self: flex-start; background: rgba(255,255,255,0.1); color: var(--text-main); border-bottom-left-radius: 2px; }
        .msg-outgoing { align-self: flex-end; background: var(--gold-main); color: #000; border-bottom-right-radius: 2px; }
        
        .back-btn { position: absolute; top: max(20px, var(--safe-top)); left: 20px; background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; z-index: 100;}
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-item { background: var(--glass-bg); padding: 10px; border-radius: 8px; border: var(--glass-border); }
        .stat-val { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 5px; }
        .c-win { color: var(--success); } .c-loss { color: var(--danger); } .c-gold { color: var(--gold-main); }
        .modal-box { background: var(--glass-panel); padding: 25px; border-radius: 15px; border: 1px solid var(--gold-main); width: 90%; max-width: 350px; text-align: center; color: var(--text-main); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: var(--glass-shadow); }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main); border-radius: 6px; }
        .highscore-list { list-style: none; font-size: 0.85rem; color: var(--text-muted); padding: 0; width: 100%;}
        .highscore-item { padding: 8px 0; border-bottom: var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .top-list-scroll { max-height: 60vh; overflow-y: auto; margin-top: 10px; width: 100%;}
        .rank-badge { display: inline-block; width: 25px; height: 25px; background: var(--glass-bg); border-radius: 50%; text-align: center; line-height: 25px; margin-right: 10px; font-weight: bold; font-size: 0.8rem; }
        .rank-1 { background: var(--gold-main); color: #000; box-shadow: 0 0 10px var(--gold-glow); }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }
        .hl-mode { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-left: 5px; border: 1px solid var(--glass-border); padding: 2px 5px; border-radius: 4px; }
        
        .logo-anim { font-size: clamp(2rem, 5vw, 4rem); text-transform: uppercase; letter-spacing: 4px; animation: fadeInOut 4.5s forwards; color: var(--text-main); text-align: center; font-weight: 700; width: 100%; display: block; }
        @keyframes fadeInOut { 0% { opacity: 0; letter-spacing: 0px; } 40% { opacity: 1; letter-spacing: 4px; } 80% { opacity: 1; } 100% { opacity: 0; } }
        .loader { border: 5px solid rgba(125,125,125,0.2); border-top: 5px solid var(--gold-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) and (orientation: portrait) {
            .chat-window { width: 85%; right: auto; left: 50%; transform: translateX(-50%); bottom: 160px; height: 320px; }
            .chat-window.active { transform: translateX(-50%); } 
            .chat-float-btn { bottom: 145px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="custom-modal">
            <div id="cm-title" class="cm-title">OBAVE≈†TENJE</div>
            <div id="cm-msg" class="cm-msg">Poruka ide ovde...</div>
            <input type="text" id="cm-input" class="cm-input hidden" autocomplete="off">
            <div class="cm-btn-group">
                <button id="cm-cancel" class="cm-btn cm-btn-cancel hidden">OTKA≈ΩI</button>
                <button id="cm-ok" class="cm-btn cm-btn-ok">U REDU</button>
            </div>
        </div>
    </div>

    <div id="chat-float-btn" class="chat-float-btn hidden" onclick="app.toggleChat()">üí¨<div id="chat-badge" class="chat-notification"></div></div>
    <div id="chat-window" class="chat-window">
        <div id="chat-header" class="chat-header"><span>CHAT</span><span style="cursor:pointer;" onclick="app.toggleChat()">‚ñº</span></div>
        <div id="chat-body" class="chat-body"></div>
        <div class="chat-footer"><input type="text" id="chat-input-field" class="chat-input" placeholder="Pi≈°i..."><button id="btn-chat-send" class="btn-chat-send">‚û§</button></div>
    </div>

    <div id="splash-screen" class="screen active">
        <div class="logo-anim">
            YAMB OF THE <span style="color:var(--gold-main)">BALKAN</span>
        </div>
    </div>

    <div id="main-menu" class="screen">
        <h1 class="menu-title">YAMB<br><span class="menu-subtitle">OF THE BALKAN</span></h1>
        
        <button id="btn-resume-game" class="btn-menu btn-resume hidden" onclick="app.loadSavedGame()">‚ñ∂ NASTAVI IGRU</button>

        <button class="btn-menu btn-primary" onclick="app.setupGame(1)">üë§ Solo Igra</button>
        <button class="btn-menu" onclick="app.setupGame(2, true)">ü§ñ Protiv AI</button>
        <button class="btn-menu" onclick="app.setupGame(2)">üë• Dva Igraƒça (Hotseat)</button>
        <button class="btn-menu" onclick="app.setupOnline('random')">üåê Naƒëi Protivnika (Random)</button>
        <button class="btn-menu" style="border-color: #2196F3; color: #2196F3;" onclick="app.startPrivateHosting()">üîó Pozovi Prijatelja</button>
        
        <button class="btn-menu" onclick="app.loadGameFromFile()">üìÇ Uƒçitaj Fajl (Backup)</button>
        <div class="menu-divider"></div>
        <button class="btn-menu" onclick="app.showHighscoresScreen()">üèÜ TOP LISTA</button>
        <button class="btn-menu" onclick="app.showStats()">üìä Statistika</button>
        <button class="btn-menu" onclick="app.showSettings()">‚öô Pode≈°avanja</button>
        <button class="btn-menu" onclick="app.showRules()">üìñ Pravila</button>
    </div>

    <div id="game-scene" class="screen">
        <div class="game-header">
            <span style="cursor: pointer; opacity: 0.8; color: var(--text-main)" onclick="app.quitToMenu()">‚úñ MENI</span>
            <span style="color:var(--gold-main); font-weight:700;">YAMB PRO</span>
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary" style="border-radius:50%; width:30px; height:30px; padding:0;" onclick="app.saveGame()">üíæ</button>
                <button class="btn-secondary" style="border-radius:50%; width:30px; height:30px; padding:0;" onclick="app.toggleTheme()">üé®</button>
            </div>
        </div>
        <div class="game-content">
            <div class="left-panel">
                <div class="tables-wrapper" id="tables-container"></div>
                <div class="controls-area">
                    <div class="dice-container" id="dice-container"></div>
                    <div class="game-info">
                        <div class="status-label" id="lbl-status">Bacanje: 0 / 3</div>
                        <div class="action-btn-group">
                            <button id="btn-najava" class="game-btn btn-secondary" onclick="app.clickNajava()" disabled>Najava</button>
                            <button id="btn-bacaj" class="game-btn btn-throw" onclick="app.throwDice()">BACAJ</button>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:5px; padding-bottom: 5px; font-size:0.8rem; color:var(--gold-main);" id="lbl-turn"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-screen" class="screen"><button class="back-btn" onclick="app.showMainMenu()">‚Üê</button><h2 class="menu-title">STATISTIKA</h2><div class="modal-box" style="width: 100%; max-width: 500px;"><div style="border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; margin-bottom: 15px;"><p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">NAJVEƒÜI SKOR</p><span id="stat-high" style="font-size: 2.5rem; color: var(--gold-main); font-weight: 700;">0</span></div><div class="stat-grid"><div class="stat-item"><span style="font-size: 0.8rem; color: var(--text-muted);">UKUPNO PARTIJA</span><span id="stat-games" class="stat-val">0</span></div><div class="stat-item"><span style="font-size: 0.8rem; color: var(--text-muted);">PROSEƒåAN SKOR</span><span id="stat-avg" class="stat-val c-gold">0</span></div><div class="stat-item"><span style="font-size: 0.8rem; color: var(--text-muted);">POBEDE</span><span id="stat-wins" class="stat-val c-win">0</span></div><div class="stat-item"><span style="font-size: 0.8rem; color: var(--text-muted);">PORAZI</span><span id="stat-losses" class="stat-val c-loss">0</span></div></div><div style="margin-top: 15px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;"><p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">USPE≈†NOST</p><span id="stat-rate" style="font-size: 1.5rem; color: var(--text-main); font-weight: 600;">0%</span></div></div></div>
    <div id="highscores-screen" class="screen"><button class="back-btn" onclick="app.showMainMenu()">‚Üê</button><h2 class="menu-title">TOP LISTA</h2><div class="modal-box" style="width: 100%; max-width: 600px; text-align: left;"><div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--gold-main); padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: var(--gold-main);"><span>IGRAƒå</span><span>SKOR</span></div><ul id="full-hs-list" class="highscore-list top-list-scroll"></ul></div></div>
    <div id="settings-screen" class="screen"><button class="back-btn" onclick="app.showMainMenu()">‚Üê</button><h2 class="menu-title">PODE≈†AVANJA</h2><div class="modal-box" style="text-align: left;"><label style="color:var(--text-muted);">Va≈°e Ime:</label><input type="text" id="setting-name" class="modal-input" placeholder="Igraƒç"><div style="margin-top: 15px;"><label style="color: var(--text-muted);">Tema:</label><select id="setting-theme" class="modal-input"><option value="dark">Dark Soft Gold (Glass)</option><option value="light">Light Gold</option><option value="medium">Medium Gold (Vesela)</option></select></div><div style="margin-top: 15px;"><label style="display: flex; align-items: center;"><input type="checkbox" id="setting-sound" style="margin-right: 10px;"> Zvuƒçni Efekti</label></div><button class="btn-menu btn-primary" style="margin-top: 20px;" onclick="app.saveSettings()">Saƒçuvaj</button></div></div>
    <div id="rules-screen" class="screen" style="overflow-y: auto;"><button class="back-btn" onclick="app.showMainMenu()">‚Üê</button><div style="max-width: 800px; padding: 25px; background: var(--glass-panel); border-radius: 10px; color: var(--text-main); margin-top: 60px; margin-bottom: 20px;"><h2 style="color:var(--gold-main); text-align:center; margin-bottom: 20px;">PRAVILA IGRE</h2><p style="margin-bottom: 15px; font-size: 0.95rem;"><strong>Cilj igre:</strong> Osvojiti ≈°to vi≈°e poena kombinovanjem 5 od 6 kockica. Imate pravo na 3 bacanja po potezu.</p><h3 style="color:var(--gold-main); margin-top:20px; font-size: 1.1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px;">KOLONE</h3><ul style="margin-left: 20px; line-height: 1.6; font-size: 0.9rem; margin-top: 10px;"><li><span class="c-nadole">‚Üì Nadole:</span> Igra se redom od 1 do Yamba.</li><li><span class="c-slobodna">S Slobodna:</span> Mo≈æe se igrati bilo koje polje u bilo kom trenutku.</li><li><span class="c-nagore">‚Üë Nagore:</span> Igra se obrnutim redom, od Yamba do 1.</li><li><span class="c-najava">üì¢ Najava:</span> Nakon prvog bacanja, igraƒç mora najaviti ≈°ta gaƒëa.</li><li><span class="c-rucno">R Ruƒçno:</span> Polje se mora popuniti iskljuƒçivo posle prvog bacanja.</li><li><span class="c-sredina">‚áÖ Sredina:</span> Popunjava se <strong>od sredine (Min, Max) ka krajevima (1, Yamb)</strong>.</li></ul><h3 style="color:var(--gold-main); margin-top:20px; font-size: 1.1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px;">BODOVANJE</h3><ul style="margin-left: 20px; line-height: 1.6; font-size: 0.9rem; margin-top: 10px;"><li><strong>1 - 6:</strong> Zbir dobijenih brojeva. (Bonus +30 ako je zbir ‚â• 60).</li><li><strong>Max:</strong> ≈†to veƒái zbir 5 kockica.</li><li><strong>Min:</strong> ≈†to manji zbir 5 kockica. <br><em style="color:var(--text-muted)">(Formula: (Max - Min) * Kec). Bonus +40 ako je rezultat ‚â• 60.</em></li><li><strong>Triling:</strong> 3 iste + 20 poena.</li><li><strong>Ful:</strong> 3 iste + 2 iste + 30 poena.</li><li><strong>Poker:</strong> 4 iste + 40 poena.</li><li><strong>Yamb:</strong> 5 istih + 50 poena.</li><li><strong>Kenta:</strong> 5 vezanih (66, 56, 46 poena).</li></ul></div></div>

    <div id="waiting-screen" class="screen">
        <div class="loader"></div>
        <h2 style="margin-top: 20px; color:var(--text-main);">ƒåEKAM PROTIVNIKA...</h2>
        <div id="share-area" class="hidden" style="margin-top:20px; text-align:center;">
            <p style="color:var(--gold-main); margin-bottom:10px;">Po≈°alji ovaj link prijatelju:</p>
            <input type="text" id="invite-link" class="modal-input" readonly style="font-size:0.8rem; width:100%; margin-bottom:10px;">
            <button class="btn-menu btn-primary" onclick="app.shareInvite()">üîó PODELI LINK</button>
        </div>
        <p id="wait-msg" style="color: var(--text-muted); margin-top:15px;">Tra≈æim server...</p>
        <button class="btn-menu btn-danger" onclick="app.cancelOnline()" style="margin-top: 30px;">ODUSTANI</button>
    </div>

    <script>
        const SERVER_URL = 'https://yamb-of-the-balkan.onrender.com';

        class Confetti { constructor() { this.canvas = document.getElementById('confetti-canvas'); this.ctx = this.canvas.getContext('2d'); this.particles = []; this.resize(); window.addEventListener('resize', () => this.resize()); this.animating = false; } resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; } start() { this.particles = []; this.animating = true; for(let i=0; i<150; i++) this.particles.push(this.createParticle()); this.animate(); } stop() { this.animating = false; this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); } createParticle() { return { x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height - this.canvas.height, color: ['#D4AF37', '#FFD700', '#FFFFFF', '#ef5350', '#4fc3f7'][Math.floor(Math.random()*5)], size: Math.random() * 8 + 4, speedY: Math.random() * 5 + 2, speedX: Math.random() * 4 - 2, rotation: Math.random() * 360, rotSpeed: Math.random() * 5 - 2 }; } animate() { if(!this.animating) return; this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.particles.forEach((p, i) => { p.y += p.speedY; p.x += p.speedX; p.rotation += p.rotSpeed; if(p.y > this.canvas.height) this.particles[i] = this.createParticle(); this.ctx.save(); this.ctx.translate(p.x, p.y); this.ctx.rotate(p.rotation * Math.PI/180); this.ctx.fillStyle = p.color; this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); this.ctx.restore(); }); requestAnimationFrame(() => this.animate()); } }
        class ModalManager { constructor() { this.overlay = document.getElementById('custom-modal-overlay'); this.titleEl = document.getElementById('cm-title'); this.msgEl = document.getElementById('cm-msg'); this.inputEl = document.getElementById('cm-input'); this.btnOk = document.getElementById('cm-ok'); this.btnCancel = document.getElementById('cm-cancel'); this.resolvePromise = null; this.btnOk.onclick = () => this.handleOk(); this.btnCancel.onclick = () => this.handleCancel(); this.inputEl.addEventListener('keydown', (e) => { if(e.key === 'Enter') this.handleOk(); }); } reset() { this.overlay.classList.remove('active'); this.inputEl.classList.add('hidden'); this.btnCancel.classList.add('hidden'); this.inputEl.value = ''; this.resolvePromise = null; } show(title, msg, type = 'alert') { return new Promise((resolve) => { this.resolvePromise = resolve; this.titleEl.innerText = title; this.msgEl.innerHTML = msg.replace(/\n/g, '<br>'); this.inputEl.classList.toggle('hidden', type !== 'prompt'); this.btnCancel.classList.toggle('hidden', type === 'alert'); this.overlay.classList.add('active'); if (type === 'prompt') this.inputEl.focus(); }); } alert(msg, title = "OBAVE≈†TENJE") { return this.show(title, msg, 'alert'); } confirm(msg, title = "POTVRDA") { return this.show(title, msg, 'confirm'); } prompt(msg, title = "UNOS") { return this.show(title, msg, 'prompt'); } handleOk() { if (this.resolvePromise) { if (!this.inputEl.classList.contains('hidden')) { this.resolvePromise(this.inputEl.value); } else { this.resolvePromise(true); } } this.reset(); } handleCancel() { if (this.resolvePromise) this.resolvePromise(false); this.reset(); } }
        const DICE_SYMBOLS = {0: "", 1: "1", 2: "2", 3: "3", 4: "4", 5: "5", 6: "6"};
        const UNICODE_DICE = {0: "", 1: "‚öÄ", 2: "‚öÅ", 3: "‚öÇ", 4: "‚öÉ", 5: "‚öÑ", 6: "‚öÖ"};
        const REDOVI_IGRA = ["1", "2", "3", "4", "5", "6", "Max", "Min", "Triling", "Kenta", "Ful", "Poker", "Yamb"];
        const REDOVI_PRIKAZ = ["1", "2", "3", "4", "5", "6", "ZBIR 1", "Max", "Min", "ZBIR 2", "Triling", "Kenta", "Ful", "Poker", "Yamb", "ZBIR 3"];
        // ISPRAVLJENO: Dodata kolona "Nagore" da se poklapa sa UI tabelom
        const KOLONE = ["Nadole", "Slobodna", "Sredina", "Nagore", "Ruƒçno", "Najava"];
        
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const sum = arr => arr.reduce((a, b) => a + b, 0);
        class SoundManager { constructor() { this.ctx = window.AudioContext ? new window.AudioContext() : new window.webkitAudioContext(); } playTone(freq, type, duration, vol=0.1) { if (!app.soundEnabled) return; try { const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime); gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration); } catch(e) {} } click() { this.playTone(800, 'sine', 0.05, 0.05); } roll() { if (!app.soundEnabled) return; this.playTone(150, 'square', 0.1, 0.02); } score() { this.playTone(600, 'sine', 0.3, 0.1); setTimeout(()=>this.playTone(900, 'sine', 0.4, 0.1), 100); } error() { this.playTone(150, 'sawtooth', 0.3, 0.1); } win() { if(!app.soundEnabled) return; [0, 200, 400, 600].forEach((t, i) => setTimeout(() => this.playTone(400 + (i*100), 'square', 0.2, 0.1), t)); } chat() { this.playTone(1200, 'sine', 0.1, 0.05); } }
        
        // --- DIVINE YAMB AI ENGINE v12.0 ---
        class YambAI {
            constructor(appInstance, difficulty = 'medium') {
                this.app = appInstance;
                this.difficulty = difficulty;
                this.colPriority = { "Nadole": 50, "Nagore": 50, "Sredina": 40, "Ruƒçno": 60, "Najava": 35, "Slobodna": 5 };
            }

            decideRoll(dice, turnNum, sheet) {
                const analysis = this.analyzeHand(dice);
                
                // --- 1. POTEZ ---
                if (turnNum === 1) {
                    const manualMove = this.checkManualOpprotunity(dice, analysis, sheet);
                    if (manualMove) return { type: 'write', row: manualMove.row, col: 'Ruƒçno' };
                    
                    if (!this.app.najavaAktivna) {
                        const bestAnnounce = this.evaluateAnnouncement(dice, analysis, sheet);
                        if (bestAnnounce) {
                            this.app.clickNajava();
                            // Simulacija ljudskog klika
                            this.app.najavljenoPolje = { row: bestAnnounce, col: 'Najava' };
                            this.app.najavaAktivna = false; 
                            
                            const btnId = `btn-${this.app.currentPlayerIdx}-Najava-${bestAnnounce}`;
                            const btnEl = document.getElementById(btnId);
                            if(btnEl) btnEl.classList.add('highlight-najava');
                            const btnN = document.getElementById('btn-najava');
                            if(btnN) { btnN.innerText = `Najava: ${bestAnnounce}`; btnN.disabled = true; btnN.classList.remove('btn-active-toggle'); }

                            const holdMask = this.getHoldMaskForTarget(dice, bestAnnounce);
                            return { type: 'hold', hold: holdMask };
                        }
                    }
                }

                // Ako imamo aktivnu najavu
                if (this.app.najavljenoPolje) {
                     if (turnNum === 3) return { type: 'write', row: this.app.najavljenoPolje.row, col: 'Najava' };
                     const holdMask = this.getHoldMaskForTarget(dice, this.app.najavljenoPolje.row);
                     return { type: 'hold', hold: holdMask };
                }

                // --- 3. POTEZ (OBAVEZAN UPIS) ---
                if (turnNum === 3) {
                    const bestMove = this.findBestScore(dice, sheet, true);
                    if (bestMove) return bestMove;
                    // Ako nema dobrog poteza, aktiviraj Inteligentno ≈Ωrtvovanje
                    return this.panicWrite(sheet);
                }

                // --- 2. POTEZ (HOLD) ---
                const bestHold = this.calculateSmartHold(dice, sheet, turnNum);
                return { type: 'hold', hold: bestHold };
            }

            evaluateAnnouncement(dice, an, sheet) {
                let bestRow = null; let maxScore = -1;
                const potentialRows = REDOVI_IGRA.filter(r => this.isAvail(r, "Najava", sheet));

                potentialRows.forEach(row => {
                    let score = 0;
                    if (row === "Yamb") { if (an.maxCount >= 4) score = 120; else if (an.maxCount >= 3) score = 45; }
                    else if (row === "Poker") { if (an.maxCount >= 4) score = 95; else if (an.maxCount >= 3) score = 55; }
                    else if (row === "Kenta") { if (an.nearKenta.length >= 4) score = 110; else if (an.nearKenta.length >= 3) score = 35; }
                    else if (row === "Ful") { 
                        if ((an.maxCount === 3 && Object.keys(an.counts).length <= 3) || an.maxCount >= 4) score = 75;
                        else if (an.counts[an.valMaxCount] === 2 && Object.keys(an.counts).length <= 3) score = 45; 
                    }
                    else if (row === "Triling") { if (an.maxCount >= 3) score = 70; }
                    else if (["1","2","3","4","5","6"].includes(row)) {
                        const val = parseInt(row); const count = dice.filter(d => d === val).length;
                        if (count >= 4) score = 80; else if (count === 3) score = 60;
                    }
                    if (score > maxScore) { maxScore = score; bestRow = row; }
                });
                if (maxScore >= 35) return bestRow;
                return null;
            }

            checkManualOpprotunity(dice, an, sheet) {
                if (!this.isAvail("1", "Ruƒçno", sheet) && !this.isAvail("Yamb", "Ruƒçno", sheet)) { 
                    const emptyManuals = REDOVI_IGRA.filter(r => sheet["Ruƒçno"][r] === null).length; 
                    if (emptyManuals === 0) return null; 
                }
                let best = null; let maxW = 0;
                REDOVI_IGRA.forEach(row => {
                    if (this.isAvail(row, "Ruƒçno", sheet)) {
                        const best5 = this.app.getBest5(row, dice); const pts = this.app.calcPoints(row, best5); let w = 0;
                        if (row === "Yamb" && pts >= 50) w = 300; 
                        else if (row === "Poker" && pts >= 40) w = 150; 
                        else if (row === "Kenta" && pts >= 56) w = 150;
                        else if (row === "Ful" && pts >= 40) w = 100;
                        else if (["1","2","3","4","5","6"].includes(row)) { 
                            const count = dice.filter(d => d === parseInt(row)).length; 
                            if (count >= 4) w = 180; else if (count === 3) w = 85; 
                        }
                        if (w > maxW) { maxW = w; best = { row, points: pts }; }
                    }
                });
                return best;
            }

            findBestScore(dice, sheet, isFinalTurn) {
                let possibleMoves = []; const cols = ["Nadole", "Nagore", "Sredina", "Ruƒçno", "Najava", "Slobodna"];
                cols.forEach(col => {
                    if (col === "Najava" && !this.app.najavaAktivna) return; if (this.app.najavaAktivna && col !== "Najava") return;
                    REDOVI_IGRA.forEach(row => {
                        if (!this.isAvail(row, col, sheet)) return; if (col === "Najava" && this.app.najavljenoPolje && this.app.najavljenoPolje.row !== row) return;
                        let best5 = this.app.getBest5(row, dice); let pts = this.app.calcPoints(row, best5); let isScratch = false;
                        if (col === "Ruƒçno" && this.app.brojBacanja > 1) { pts = 0; isScratch = true; }
                        
                        let weight = pts; weight += this.colPriority[col];
                        if (row === "Yamb" && pts >= 50) weight += 1000;
                        if (row === "Kenta" && pts >= 40) weight += 500;
                        if (row === "Poker" && pts >= 40) weight += 300;
                        
                        if (this.isNextInColumn(row, col, sheet)) weight += 50; // Bonus za redosled
                        
                        possibleMoves.push({ type: 'write', row, col, points: pts, weight });
                    });
                });
                possibleMoves.sort((a, b) => b.weight - a.weight);
                if (possibleMoves.length > 0) return possibleMoves[0];
                return null;
            }

            isNextInColumn(row, col, sheet) {
                if (col === "Nadole") { const idx = REDOVI_IGRA.indexOf(row); if (idx === 0) return true; if (sheet[col][REDOVI_IGRA[idx-1]] !== null) return true; }
                if (col === "Nagore") { const idx = REDOVI_IGRA.indexOf(row); if (idx === REDOVI_IGRA.length - 1) return true; if (sheet[col][REDOVI_IGRA[idx+1]] !== null) return true; }
                
                // ISPRAVLJENO: AI SREDINA LOGIKA (Max->1 i Min->Yamb)
                if (col === "Sredina") {
                    const up = ["Max", "6", "5", "4", "3", "2", "1"]; 
                    const down = ["Min", "Triling", "Kenta", "Ful", "Poker", "Yamb"];
                    
                    if (up.includes(row)) { 
                        const idx = up.indexOf(row); 
                        if (idx === 0) return true; 
                        if (sheet[col][up[idx-1]] !== null) return true; 
                    }
                    if (down.includes(row)) { 
                        const idx = down.indexOf(row); 
                        if (idx === 0) return true; 
                        if (sheet[col][down[idx-1]] !== null) return true; 
                    }
                    return false;
                }
                return false;
            }

            panicWrite(sheet) {
                // Pametno ≈ærtvovanje - tra≈æi polje koje najmanje boli
                const priorityOrder = [
                    {col: "Ruƒçno", row: "Yamb"}, {col: "Ruƒçno", row: "Poker"}, {col: "Slobodna", row: "1"}, 
                    {col: "Sredina", row: "1"}, {col: "Nadole", row: "1"}, {col: "Nagore", row: "Yamb"},
                    {col: "Slobodna", row: "2"}, {col: "Ruƒçno", row: "2"}
                ];
                
                for (let p of priorityOrder) {
                    if (this.isAvail(p.row, p.col, sheet)) return { type: 'write', row: p.row, col: p.col };
                }
                
                // Ako ni≈°ta od prioriteta, daj prvo slobodno
                for (let col of ["Ruƒçno", "Slobodna", "Sredina", "Nadole", "Nagore"]) { 
                    if (col === "Najava" && !this.app.najavaAktivna) continue; 
                    for (let row of REDOVI_IGRA) { if (this.isAvail(row, col, sheet)) return { type: 'write', row: row, col: col }; } 
                }
                return { type: 'write', row: '1', col: 'Slobodna' }; // Fallback
            }

            calculateSmartHold(dice, sheet, turnNum) {
                if (this.app.najavljenoPolje) return this.getHoldMaskForTarget(dice, this.app.najavljenoPolje.row);
                
                // Analiza ≈°ta jurimo
                const an = this.analyzeHand(dice);
                
                // Juri Yamb/Poker
                if (an.maxCount >= 3) return this.getHoldMaskForTarget(dice, "Yamb");
                
                // Juri Kentu
                if (an.nearKenta.length >= 4) return dice.map(d => an.nearKenta.includes(d));
                
                // Juri Ful (ako ima 2 para ili 3 ista)
                if (Object.keys(an.counts).length <= 3) return this.getHoldMaskForTarget(dice, "Ful");

                // Juri Max/Min
                const needMax = ["Nadole", "Nagore", "Slobodna"].some(c => this.isAvail("Max", c, sheet));
                if (needMax) {
                    const highDice = dice.filter(d => d >= 4).length;
                    if (highDice >= 3) return dice.map(d => d >= 4);
                }
                
                return [false, false, false, false, false, false];
            }

            isAvail(row, col, sheet) { return sheet[col][row] === null && this.app.isValidColumnOrder(row, col, sheet); }

            getHoldMaskForTarget(dice, row) {
                if (["1","2","3","4","5","6"].includes(row)) return dice.map(d => d === parseInt(row));
                if (["Yamb", "Poker", "Triling"].includes(row)) { 
                    const counts = {}; dice.forEach(x => counts[x] = (counts[x] || 0) + 1); 
                    let maxVal = dice[0]; let maxC = 0; 
                    for(let k in counts) { if(counts[k] > maxC || (counts[k]==maxC && parseInt(k)>maxVal)) { maxC = counts[k]; maxVal = parseInt(k); } } 
                    return dice.map(d => d == maxVal); 
                }
                if (row === "Ful") {
                    const counts = {}; dice.forEach(x => counts[x] = (counts[x] || 0) + 1);
                    const triples = Object.keys(counts).filter(k => counts[k] >= 3).map(Number);
                    const pairs = Object.keys(counts).filter(k => counts[k] >= 2).map(Number);
                    if (triples.length > 0) {
                        const target3 = Math.max(...triples); 
                        const remaining = dice.filter(d => d !== target3);
                        const c2 = {}; remaining.forEach(x => c2[x] = (c2[x]||0)+1);
                        const p2 = Object.keys(c2).filter(k => c2[k]>=2).map(Number);
                        const target2 = p2.length > 0 ? Math.max(...p2) : null;
                        return dice.map(d => d === target3 || d === target2);
                    }
                    if (pairs.length >= 2) return dice.map(d => pairs.includes(d));
                    if (pairs.length === 1) return dice.map(d => d === pairs[0]);
                    return this.getHoldMaskForTarget(dice, "Yamb");
                }
                if (row === "Kenta") { 
                    const unique = [...new Set(dice)].sort((a,b)=>a-b);
                    const seq4_low = [1,2,3,4].filter(x=>unique.includes(x)).length;
                    const seq4_high = [3,4,5,6].filter(x=>unique.includes(x)).length;
                    let targetSeq = [1,2,3,4,5]; if (seq4_high > seq4_low) targetSeq = [2,3,4,5,6];
                    const used = new Set(); 
                    return dice.map(d => { if(targetSeq.includes(d) && !used.has(d)) { used.add(d); return true; } return false; }); 
                }
                if (row === "Max") return dice.map(d => d >= 4);
                if (row === "Min") return dice.map(d => d <= 3);
                return [false,false,false,false,false,false];
            }

            analyzeHand(dice) {
                const counts = {}; dice.forEach(x => counts[x] = (counts[x] || 0) + 1);
                const maxCount = Math.max(...Object.values(counts));
                const valMaxCount = Number(Object.keys(counts).find(key => counts[key] === maxCount));
                const uniqueDice = [...new Set(dice)].sort((a,b)=>a-b);
                let bestStraight = [], maxStraightLen = 0; 
                [[1,2,3,4,5], [2,3,4,5,6]].forEach(seq => { 
                    const match = seq.filter(x => uniqueDice.includes(x)); 
                    if (match.length > maxStraightLen) { maxStraightLen = match.length; bestStraight = match; } 
                });
                if (maxStraightLen < 4) {
                     [[1,2,3,4], [2,3,4,5], [3,4,5,6]].forEach(seq => {
                        const match = seq.filter(x => uniqueDice.includes(x));
                        if (match.length >= 4 && match.length > maxStraightLen) { maxStraightLen = match.length; bestStraight = match; }
                     });
                }
                return { counts, maxCount, valMaxCount, nearKenta: maxStraightLen >= 3 ? bestStraight : [], unique: uniqueDice };
            }
        }

        class YambApp {
            constructor() {
                this.players = []; this.allScores = []; this.currentPlayerIdx = 0;
                this.gameActive = false; this.aiMode = false; this.aiDifficulty = "medium"; this.ai = null;
                this.kockiceVals = [0,0,0,0,0,0]; this.zadrzane = [false,false,false,false,false,false];
                this.brojBacanja = 0; this.najavaAktivna = false; this.najavljenoPolje = null;
                this.modeTag = "Solo"; this.chatOpen = false; this.unreadMsgs = 0;
                this.aiPhrases = { start: ["Sreƒáno!"], goodMove: ["Bravo!"], badMove: ["Moglo je bolje."], aiGood: ["To!"], thinking: ["Hmm..."], win: ["Pobedio sam!"], lose: ["ƒåestitam!"] };
                try { const hsData = localStorage.getItem('yamb_highscores_v2'); this.highscores = hsData ? JSON.parse(hsData) : []; } catch(e) { this.highscores = []; }
                this.socket = null; this.onlineMode = false; this.myOnlineIndex = 0;
                this.playerName = localStorage.getItem('yamb_player_name') || "Igraƒç";
                this.soundEnabled = localStorage.getItem('yamb_sound') === 'true';
                const savedStats = JSON.parse(localStorage.getItem('yamb_stats'));
                this.stats = savedStats || { games: 0, wins: 0, losses: 0, highscore: 0, totalScoreSum: 0 };
                this.diceBtns = []; this.soundMgr = new SoundManager(); this.modal = new ModalManager(); this.confetti = new Confetti();
                this.dragElement(document.getElementById("chat-window"));
                const btnSend = document.getElementById('btn-chat-send');
                btnSend.addEventListener('click', () => this.sendChat());
                btnSend.addEventListener('touchend', (e) => { e.preventDefault(); this.sendChat(); });
                document.getElementById('chat-input-field').addEventListener('keydown', (e) => { if (e.key === 'Enter') this.sendChat(); });
                const savedTheme = localStorage.getItem('yamb_theme');
                if (savedTheme === 'light') document.body.classList.add('light-theme'); else if (savedTheme === 'medium') document.body.classList.add('medium-theme');
                setTimeout(() => { this.checkForInvite(); }, 1000);
                setTimeout(() => { this.navigateTo('main-menu'); }, 4500);
                this.uiInit();
            }

            checkForInvite() { const params = new URLSearchParams(window.location.search); const roomId = params.get('room'); if (roomId) { this.navigateTo('splash-screen'); setTimeout(async () => { const nickname = await this.modal.prompt("Unesite Va≈° nadimak:", "PRIDRU≈ΩIVANJE IGRI"); if (nickname) { this.joinPrivateGame(nickname, roomId); } else { this.navigateTo('main-menu'); } }, 500); } }
            navigateTo(screenId) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); const target = document.getElementById(screenId); if (target) target.classList.add('active'); if(screenId === 'main-menu') this.checkSavedGame(); }
            uiInit() { const diceCont = document.getElementById('dice-container'); diceCont.innerHTML = ""; for (let i = 0; i < 6; i++) { let btn = document.createElement('div'); btn.className = 'dice'; btn.innerText = ''; btn.onclick = () => this.toggleHold(i); diceCont.appendChild(btn); this.diceBtns.push(btn); } }
            dragElement(elmnt) { var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; var header = document.getElementById("chat-header"); if (header) { header.onmousedown = dragMouseDown; header.ontouchstart = dragMouseDown; } function dragMouseDown(e) { e = e || window.event; if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') { if(e.type === 'touchstart') { pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; } else { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; } document.onmouseup = closeDragElement; document.onmousemove = elementDrag; document.ontouchend = closeDragElement; document.ontouchmove = elementDrag; } } function elementDrag(e) { e = e || window.event; let clientX, clientY; if(e.type === 'touchmove') { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { e.preventDefault(); clientX = e.clientX; clientY = e.clientY; } pos1 = pos3 - clientX; pos2 = pos4 - clientY; pos3 = clientX; pos4 = clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; elmnt.style.bottom = "auto"; elmnt.style.right = "auto"; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; } }
            toggleChat() { this.chatOpen = !this.chatOpen; const win = document.getElementById('chat-window'); const badge = document.getElementById('chat-badge'); if (this.chatOpen) { win.classList.add('active'); badge.classList.remove('active'); this.unreadMsgs = 0; const body = document.getElementById('chat-body'); body.scrollTop = body.scrollHeight; } else { win.classList.remove('active'); } }
            appendChatMessage(sender, text, type) { const body = document.getElementById('chat-body'); const msgDiv = document.createElement('div'); msgDiv.className = `msg-bubble ${type}`; msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`; body.appendChild(msgDiv); body.scrollTop = body.scrollHeight; if (!this.chatOpen) { this.unreadMsgs++; document.getElementById('chat-badge').classList.add('active'); this.soundMgr.chat(); } }
            sendChat() { const input = document.getElementById('chat-input-field'); const text = input.value.trim(); if (!text) return; this.appendChatMessage("Ti", text, "msg-outgoing"); input.value = ""; if (this.onlineMode && this.socket) { this.socket.emit('chat_msg', { roomId: this.roomId, msg: text }); } }
            triggerAiChat(category) { if (!this.aiMode) return; const phrases = this.aiPhrases[category]; if (phrases && phrases.length > 0) { const text = phrases[Math.floor(Math.random() * phrases.length)]; setTimeout(() => { this.appendChatMessage("AI", text, "msg-incoming"); }, 1000 + Math.random() * 2000); } }
            showSettings() { this.navigateTo('settings-screen'); document.getElementById('setting-name').value = this.playerName; document.getElementById('setting-sound').checked = this.soundEnabled; document.getElementById('setting-theme').value = localStorage.getItem('yamb_theme') || 'dark'; }
            saveSettings() { const newName = document.getElementById('setting-name').value.trim(); if(newName) this.playerName = newName; this.soundEnabled = document.getElementById('setting-sound').checked; const selectedTheme = document.getElementById('setting-theme').value; localStorage.setItem('yamb_theme', selectedTheme); document.body.classList.remove('light-theme', 'medium-theme'); if (selectedTheme === 'light') document.body.classList.add('light-theme'); else if (selectedTheme === 'medium') document.body.classList.add('medium-theme'); localStorage.setItem('yamb_player_name', this.playerName); localStorage.setItem('yamb_sound', this.soundEnabled); this.showMainMenu(); }
            showStats() { this.navigateTo('stats-screen'); document.getElementById('stat-games').innerText = this.stats.games; document.getElementById('stat-high').innerText = this.stats.highscore; document.getElementById('stat-wins').innerText = this.stats.wins; document.getElementById('stat-losses').innerText = this.stats.losses; const avg = this.stats.games > 0 ? Math.round(this.stats.totalScoreSum / this.stats.games) : 0; document.getElementById('stat-avg').innerText = avg; const totalCompetitive = this.stats.wins + this.stats.losses; let rate = 0; if (totalCompetitive > 0) rate = Math.round((this.stats.wins / totalCompetitive) * 100); document.getElementById('stat-rate').innerText = rate + "%"; }
            showHighscoresScreen() { this.navigateTo('highscores-screen'); const list = document.getElementById('full-hs-list'); list.innerHTML = ""; if (this.highscores.length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px; color:#777;'>Jo≈° nema rezultata.</div>"; return; } this.highscores.forEach((entry, i) => { let li = document.createElement('li'); li.className = 'highscore-item'; let rankClass = i===0?'rank-1':(i===1?'rank-2':(i===2?'rank-3':'rank-other')); li.innerHTML = `<div style="display:flex; align-items:center;"><span class="rank-badge ${rankClass}">${i+1}</span><div><span style="font-weight:600;">${entry.name}</span><span class="hl-mode">${entry.mode}</span><div style="font-size:0.7rem; color:var(--text-muted);">${entry.date || '-'}</div></div></div><span style="color:var(--gold-main); font-weight:700; font-size:1.1rem;">${entry.score}</span>`; list.appendChild(li); }); }
            saveHighscoreEntry(name, score, mode) { const date = new Date().toLocaleDateString('sr-RS'); this.highscores.push({ name, score, mode, date }); this.highscores.sort((a,b) => b.score - a.score); this.highscores = this.highscores.slice(0, 20); localStorage.setItem('yamb_highscores_v2', JSON.stringify(this.highscores)); }
            updateHighscoresUI() { /* Sidebar lista je uklonjena */ }
            updateStats(score, resultType) { this.stats.games++; this.stats.totalScoreSum += score; if (score > this.stats.highscore) this.stats.highscore = score; if (resultType === 'win') this.stats.wins++; else if (resultType === 'loss') this.stats.losses++; localStorage.setItem('yamb_stats', JSON.stringify(this.stats)); }
            toggleTheme() { const current = localStorage.getItem('yamb_theme') || 'dark'; let next = 'dark'; document.body.classList.remove('light-theme', 'medium-theme'); if (current === 'dark') { next = 'light'; document.body.classList.add('light-theme'); } else if (current === 'light') { next = 'medium'; document.body.classList.add('medium-theme'); } else { next = 'dark'; } localStorage.setItem('yamb_theme', next); }
            showMainMenu() { this.navigateTo('main-menu'); document.getElementById('chat-float-btn').classList.add('hidden'); document.getElementById('chat-window').classList.remove('active'); this.chatOpen = false; }
            showRules() { this.navigateTo('rules-screen'); }
            async quitToMenu() { if (await this.modal.confirm("Da li ste sigurni da ≈æelite prekinuti igru?")) { if(this.socket) this.socket.disconnect(); this.showMainMenu(); } }

            async startPrivateHosting() { const nickname = await this.modal.prompt("Unesite Va≈° nadimak:", "ONLINE PRIJAVA"); if (!nickname) return; const roomId = "yamb-" + Math.random().toString(36).substring(2, 8); const shareUrl = SERVER_URL + "/?room=" + roomId; this.navigateTo('waiting-screen'); document.getElementById('wait-msg').innerText = "ƒåekam prijatelja..."; document.getElementById('share-area').classList.remove('hidden'); document.getElementById('invite-link').value = shareUrl; this.joinPrivateGame(nickname, roomId); }
            async joinPrivateGame(nickname, roomId) { this.navigateTo('waiting-screen'); try { this.socket = io(SERVER_URL, { transports: ['websocket'] }); } catch(e) { await this.modal.alert("Server nije dostupan."); this.showMainMenu(); return; } this.socket.on('connect', () => { this.socket.emit('join_private_game', { nickname, roomId }); }); this.setupSocketListeners(nickname); }
            async setupOnline(mode = 'random') { const nickname = await this.modal.prompt("Unesite Va≈° nadimak:", "ONLINE PRIJAVA"); if (!nickname) return; this.navigateTo('waiting-screen'); document.getElementById('share-area').classList.add('hidden'); try { this.socket = io(SERVER_URL, { transports: ['websocket'] }); } catch(e) { await this.modal.alert("Server nije dostupan."); this.showMainMenu(); return; } this.socket.on('connect', () => { document.getElementById('wait-msg').innerText = "Tra≈æim protivnika..."; this.socket.emit('find_game', nickname); }); this.setupSocketListeners(nickname); }
            setupSocketListeners(nickname) { this.socket.on('room_full', async () => { await this.modal.alert("Ova soba je puna ili igra veƒá traje!"); this.cancelOnline(); }); this.socket.on('private_waiting', (data) => { this.roomId = data.roomId; }); this.socket.on('game_start', (data) => { this.myOnlineIndex = data.myIndex; this.onlineMode = true; this.modeTag = "Online"; this.roomId = data.roomId; this.players = this.myOnlineIndex === 0 ? [nickname, data.opponent] : [data.opponent, nickname]; this.initScores(); this.currentPlayerIdx = 0; this.startGame(); }); this.socket.on('remote_move', (data) => { const opponentIdx = this.myOnlineIndex === 0 ? 1 : 0; this.allScores[opponentIdx][data.col][data.row] = data.points; this.updateTableVisuals(); this.switchPlayer(); }); this.socket.on('remote_roll', (data) => { this.visualRoll(data.values); this.brojBacanja = data.bacanje; document.getElementById('lbl-status').innerText = `Bacanje: ${data.bacanje} / 3 (Protivnik)`; }); this.socket.on('remote_hold', (data) => { this.zadrzane[data.index] = data.status; this.updateDiceVisuals(); }); this.socket.on('remote_announce', (data) => { this.najavaAktivna = true; }); this.socket.on('chat_msg', (data) => { if (data.msg) this.appendChatMessage("Protivnik", data.msg, "msg-incoming"); }); this.socket.on('opponent_left', async () => { await this.modal.alert("Protivnik je iza≈°ao!"); this.cancelOnline(); }); }
            async shareInvite() { const link = document.getElementById('invite-link').value; if (navigator.share) { try { await navigator.share({ title: 'Yamb of the Balkan', text: 'Ajde na partiju Yamba!', url: link }); } catch (err) { console.log('Share canceled'); } } else { const input = document.getElementById('invite-link'); input.select(); document.execCommand('copy'); await this.modal.alert("Link je kopiran! Po≈°alji ga prijatelju."); } }
            cancelOnline() { if(this.socket) this.socket.disconnect(); this.showMainMenu(); window.history.pushState({}, document.title, window.location.pathname); }
            async setupGame(numPlayers, aiMode=false, diff='medium') { this.onlineMode = false; this.players = []; this.allScores = []; this.aiMode = aiMode; this.aiDifficulty = diff; const p1Name = this.playerName; if (aiMode) { this.modeTag = "vs AI"; this.players.push(p1Name); this.players.push(`ü§ñ AI (Ultimate)`); this.ai = new YambAI(this); } else { this.players.push(p1Name); if (numPlayers === 1) { this.modeTag = "Solo"; } else { this.modeTag = "1 na 1"; for(let i=1; i<numPlayers; i++) { let guestName = await this.modal.prompt(`Ime igraƒça ${i+1}:`); this.players.push(guestName || `Gost ${i}`); } } } this.initScores(); this.currentPlayerIdx = 0; this.startGame(); }
            initScores() { this.allScores = []; this.players.forEach(() => { let sheet = {}; KOLONE.forEach(c => { sheet[c] = {}; REDOVI_IGRA.forEach(r => sheet[c][r] = null); }); this.allScores.push(sheet); }); }
            startGame() { this.navigateTo('game-scene'); this.createScoreTables(); this.resetTurnLogic(); this.gameActive = true; this.updateHighscoresUI(); document.getElementById('chat-body').innerHTML = ""; const chatBtn = document.getElementById('chat-float-btn'); if (this.modeTag === "Solo" || this.modeTag === "1 na 1") { chatBtn.classList.add('hidden'); } else { chatBtn.classList.remove('hidden'); if(this.aiMode) this.triggerAiChat('start'); } }
            createScoreTables() { const container = document.getElementById('tables-container'); container.innerHTML = ''; this.players.forEach((player, pIdx) => { const tableDiv = document.createElement('div'); tableDiv.className = 'player-table'; tableDiv.id = `ptable-${pIdx}`; const nameDiv = document.createElement('div'); nameDiv.className = 'player-name'; nameDiv.innerText = player; tableDiv.appendChild(nameDiv); const grid = document.createElement('div'); grid.className = 'grid-container'; ["", "‚Üì", "S", "‚áÖ", "‚Üë", "R", "üì¢"].forEach((s, i) => { let d = document.createElement('div'); d.className = 'grid-cell col-header ' + ["", "c-nadole", "c-slobodna", "c-sredina", "c-nagore", "c-rucno", "c-najava"][i]; d.innerText = s; grid.appendChild(d); }); REDOVI_PRIKAZ.forEach(row => { let lbl = document.createElement('div'); lbl.className = 'grid-cell row-header' + (row.includes("ZBIR") ? " sum" : ""); lbl.innerText = row; grid.appendChild(lbl); KOLONE.forEach(col => { let cell = document.createElement('div'); cell.className = 'grid-cell'; if (row.includes("ZBIR")) { cell.style.fontWeight = 'bold'; cell.innerText = "0"; cell.id = `sum-${pIdx}-${col}-${row}`; cell.style.color = "var(--gold-main)"; } else { let btn = document.createElement('button'); btn.className = 'score-btn'; btn.id = `btn-${pIdx}-${col}-${row}`; btn.onclick = () => this.writeScore(row, col, pIdx); btn.disabled = true; cell.appendChild(btn); } grid.appendChild(cell); }); }); tableDiv.appendChild(grid); let totalDiv = document.createElement('div'); totalDiv.className = 'total-score'; totalDiv.id = `total-${pIdx}`; totalDiv.innerText = "0"; tableDiv.appendChild(totalDiv); container.appendChild(tableDiv); }); }
            
            // --- POTPUNO REVIDIRANA LOGIKA BACANJA ---
            resetTurnLogic() { 
                this.kockiceVals = [0,0,0,0,0,0]; 
                this.zadrzane = [false,false,false,false,false,false]; 
                this.brojBacanja = 0; 
                this.najavaAktivna = false; 
                this.najavljenoPolje = null; 
                document.getElementById('lbl-status').innerText = "Bacanje: 0 / 3"; 
                
                const isAi = this.players[this.currentPlayerIdx].includes("AI"); 
                const isOnlineOpponent = (this.onlineMode && this.currentPlayerIdx !== this.myOnlineIndex); 
                const canInteract = !isAi && !isOnlineOpponent; 
                
                const btnBacaj = document.getElementById('btn-bacaj'); 
                btnBacaj.disabled = !canInteract; // Ako je moj red, dugme je AKTIVNO
                btnBacaj.innerText = "BACAJ"; 
                
                const btnNajava = document.getElementById('btn-najava'); 
                btnNajava.disabled = true; 
                btnNajava.innerText = "Najava"; 
                btnNajava.classList.remove('btn-active-toggle'); 
                
                this.diceBtns.forEach(b => { b.innerText = ""; b.className = 'dice'; }); 
                this.highlightCurrentPlayer(); 
                this.updateTableVisuals(); 
                
                if (isAi) { setTimeout(() => this.runAiTurn(), 1000); } 
            }

            highlightCurrentPlayer() { document.querySelectorAll('.player-table').forEach(el => {el.style.border = "var(--glass-border)"; el.style.boxShadow="none"}); const activeTbl = document.getElementById(`ptable-${this.currentPlayerIdx}`); if(activeTbl) { activeTbl.style.border = "2px solid var(--gold-main)"; if(window.innerWidth <= 800) activeTbl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } document.getElementById('lbl-turn').innerText = this.players[this.currentPlayerIdx] + " je na potezu"; }
            
            toggleHold(i) { 
                if (this.onlineMode && this.currentPlayerIdx !== this.myOnlineIndex) return; 
                if (this.brojBacanja === 0) return; 
                this.zadrzane[i] = !this.zadrzane[i]; 
                this.updateDiceVisuals(); 
                this.soundMgr.click(); 
                if(this.onlineMode) { this.socket.emit('dice_hold', { roomId: this.roomId, index: i, status: this.zadrzane[i] }); } 
            }
            
            updateDiceVisuals() { this.diceBtns.forEach((b, i) => { if (this.brojBacanja > 0) { b.innerText = UNICODE_DICE[this.kockiceVals[i]]; b.className = this.zadrzane[i] ? 'dice held' : 'dice active'; } else { b.innerText = ""; b.className = 'dice'; } }); }
            
            async visualRoll(finalValues) { 
                this.diceBtns.forEach((b, i) => { if(!this.zadrzane[i]) b.classList.add('rolling'); }); 
                this.soundMgr.roll(); 
                for(let k=0; k<8; k++) { 
                    this.diceBtns.forEach((b, i) => { if (!this.zadrzane[i]) b.innerText = UNICODE_DICE[Math.floor(Math.random()*6)+1]; }); 
                    await sleep(40); 
                } 
                this.diceBtns.forEach(b => b.classList.remove('rolling')); 
                this.kockiceVals = finalValues; 
                this.updateDiceVisuals(); 
            }
            
            async throwDice() { 
                const btnBacaj = document.getElementById('btn-bacaj');
                const btnNajava = document.getElementById('btn-najava');
                const isOnlineOpponent = (this.onlineMode && this.currentPlayerIdx !== this.myOnlineIndex); 
                
                // Uklonili smo isAiCheck jer je blokirao AI da izvr≈°i funkciju
                if (this.brojBacanja >= 3 || isOnlineOpponent) return; 
                if (this.najavaAktivna) { await this.modal.alert("Morate prvo odabrati polje za najavu!"); return; }

                btnBacaj.disabled = true; 
                
                try {
                    this.soundMgr.roll(); 
                    
                    let newValues = [...this.kockiceVals]; 
                    for(let i=0; i<6; i++) { if (!this.zadrzane[i]) newValues[i] = Math.floor(Math.random()*6)+1; } 
                    
                    if (this.onlineMode) { this.socket.emit('dice_roll', { roomId: this.roomId, values: newValues, bacanje: this.brojBacanja + 1 }); } 
                    
                    this.diceBtns.forEach((b, i) => { if(!this.zadrzane[i]) b.classList.add('rolling'); }); 
                    for(let k=0; k<6; k++) { 
                        this.diceBtns.forEach((b, i) => { if (!this.zadrzane[i]) b.innerText = UNICODE_DICE[Math.floor(Math.random()*6)+1]; }); 
                        await sleep(50); 
                    } 
                    this.diceBtns.forEach(b => b.classList.remove('rolling')); 
                    
                    this.kockiceVals = newValues; 
                    this.brojBacanja++; 
                    document.getElementById('lbl-status').innerText = `Bacanje: ${this.brojBacanja} / 3`; 
                    this.updateDiceVisuals(); 
                    
                } catch(e) {
                    console.error("Gre≈°ka pri bacanju:", e);
                } finally {
                    try {
                        this.updateTableVisuals();
                    } catch(err) { console.error("Gre≈°ka pri osve≈æavanju tabele:", err); }

                    // Provera da li je AI na potezu - ako jeste, dugme ostaje disabled za tebe
                    const isAi = this.players[this.currentPlayerIdx].includes("AI");

                    if (this.brojBacanja < 3 && !isAi && !isOnlineOpponent) { 
                        btnBacaj.disabled = false; 
                        btnBacaj.innerText = "BACAJ";
                    } else { 
                        btnBacaj.disabled = true; 
                        btnBacaj.innerText = "UPI≈†I"; 
                    } 
                    
                    if (this.brojBacanja === 1 && !isAi) { 
                        btnNajava.disabled = false; 
                        btnNajava.classList.add('btn-highlight'); 
                    } else { 
                        btnNajava.disabled = true; 
                        btnNajava.classList.remove('btn-highlight'); 
                    }
                }
            }

            clickNajava() { 
                if (this.brojBacanja !== 1) return; 
                const btn = document.getElementById('btn-najava'); 
                const btnBacaj = document.getElementById('btn-bacaj');

                if (!this.najavaAktivna) { 
                    this.najavaAktivna = true; 
                    btn.innerText = "OPOZOVI"; 
                    btn.classList.add('btn-active-toggle'); 
                    btn.classList.remove('btn-highlight'); 
                    btnBacaj.disabled = true; 
                    if(this.onlineMode) this.socket.emit('announce', { roomId: this.roomId, type: 'start' }); 
                } else { 
                    this.najavaAktivna = false; 
                    btn.innerText = "Najava"; 
                    btn.classList.remove('btn-active-toggle'); 
                    btn.classList.add('btn-highlight'); 
                    btnBacaj.disabled = false; 
                    if(this.onlineMode) this.socket.emit('announce', { roomId: this.roomId, type: 'cancel' }); 
                } 
            }

            isValidColumnOrder(row, col, sheet) { 
                // Provera za Nadole (od 1 do Yamb)
                if (col === "Nadole") { 
                    const idx = REDOVI_IGRA.indexOf(row); 
                    if (idx > 0 && sheet["Nadole"][REDOVI_IGRA[idx-1]] === null) return false; 
                } 
                
                // Provera za Nagore (od Yamb do 1)
                if (col === "Nagore") { 
                    const idx = REDOVI_IGRA.indexOf(row); 
                    if (idx < REDOVI_IGRA.length-1 && sheet["Nagore"][REDOVI_IGRA[idx+1]] === null) return false; 
                } 
                
                // ISPRAVKA ZA SREDINU: Jedan krak od Max ka 1, drugi od Min ka Yambu
                if (col === "Sredina") { 
                    const up = ["Max", "6", "5", "4", "3", "2", "1"]; 
                    const down = ["Min", "Triling", "Kenta", "Ful", "Poker", "Yamb"]; 
                    
                    // Smer 1: Od Max ka 1
                    if (up.includes(row)) { 
                        const idx = up.indexOf(row); 
                        if (idx === 0) return true; // Max je uvek dostupan ako je prazan
                        return sheet[col][up[idx-1]] !== null; // Prethodno polje mora biti popunjeno
                    } 
                    // Smer 2: Od Min ka Yambu
                    else if (down.includes(row)) { 
                        const idx = down.indexOf(row); 
                        if (idx === 0) return true; // Min je uvek dostupan ako je prazan
                        return sheet[col][down[idx-1]] !== null; // Prethodno polje mora biti popunjeno
                    } 
                    
                    // Ako red nije ni u jednoj definisanoj putanji za sredinu
                    return false; 
                } 
                
                // Ostale kolone (Slobodna, Ruƒçno, Najava) nemaju strogi redosled ovde
                return true; 
            }
            
            async writeScore(row, col, pIdx) { 
                if (pIdx !== this.currentPlayerIdx) return; 
                if (this.brojBacanja === 0) { this.soundMgr.error(); return await this.modal.alert("Prvo baci kockice!"); } 
                
                const sheet = this.allScores[pIdx]; 
                if (sheet[col][row] !== null) return await this.modal.alert("Popunjeno!"); 
                
                const isHuman = !this.players[pIdx].includes("AI"); 
                
                if (isHuman && this.najavaAktivna) { 
                    if (col !== "Najava") { 
                        this.soundMgr.error(); 
                        return await this.modal.alert("Ukljuƒçili ste najavu!\nMorate odabrati polje u koloni NAJAVA koje gaƒëate."); 
                    } 
                    
                    this.najavljenoPolje = {row, col}; 
                    this.najavaAktivna = false; 
                    
                    document.getElementById(`btn-${pIdx}-${col}-${row}`).classList.add('highlight-najava'); 
                    
                    const btnN = document.getElementById('btn-najava'); 
                    btnN.innerText = `Najava: ${row}`; 
                    btnN.disabled = true; 
                    btnN.classList.remove('btn-active-toggle'); 
                    
                    const btnBacaj = document.getElementById('btn-bacaj');
                    btnBacaj.disabled = false;
                    btnBacaj.innerText = "BACAJ";
                    
                    if(this.onlineMode) this.socket.emit('announce', { roomId: this.roomId, type: 'selected', row: row }); 
                    
                    return; 
                } 
                
                if (this.najavljenoPolje) { 
                    if (col !== "Najava" || row !== this.najavljenoPolje.row) { 
                        this.soundMgr.error(); 
                        return await this.modal.alert(`Najavili ste ${this.najavljenoPolje.row}!\nMorate popuniti to polje (ili upisati 0 u njega).`); 
                    } 
                } 
                
                if (!this.isValidColumnOrder(row, col, sheet)) { this.soundMgr.error(); return await this.modal.alert("Pogre≈°an redosled popunjavanja kolone!"); } 
                
                const best5 = this.getBest5(row, this.kockiceVals); 
                let pts = this.calcPoints(row, best5); 
                
                if (col === "Ruƒçno" && this.brojBacanja > 1) { 
                    if(isHuman) { 
                        const confirmZero = await this.modal.confirm("Ruƒçno kolona se popunjava samo posle 1. bacanja.\nOvo ƒáe biti upisano kao 0 (precrtavanje).\nDa li ≈æelite da nastavite?"); 
                        if (!confirmZero) return; 
                    } 
                    pts = 0; 
                } 
                
                sheet[col][row] = pts; 
                this.soundMgr.score(); 
                
                if (this.onlineMode && isHuman) { this.socket.emit('player_move', { roomId: this.roomId, row, col, points: pts }); } 
                if (this.aiMode && isHuman) { if (pts >= 40) this.triggerAiChat('goodMove'); else if (pts <= 5) this.triggerAiChat('badMove'); } 
                if (pts >= 50 && row === "Yamb") this.confetti.start(); 
                setTimeout(() => this.confetti.stop(), 3000); 
                
                this.updateTableVisuals(); 
                this.switchPlayer(); 
            }
            
            switchPlayer() { let gameOver = true; this.allScores.forEach(s => { KOLONE.forEach(c => { REDOVI_IGRA.forEach(r => { if (s[c][r] === null) gameOver = false; }); }); }); if (gameOver) { this.handleGameOver(); return; } this.currentPlayerIdx = (this.currentPlayerIdx + 1) % this.players.length; this.resetTurnLogic(); this.autoSaveGame(); }
            async handleGameOver() { localStorage.removeItem('yamb_saved_game'); this.gameActive = false; const results = []; this.players.forEach((name, i) => { let total = parseInt(document.getElementById(`total-${i}`).innerText); results.push({name, score: total}); }); this.players.forEach((name, i) => { if (!name.includes("AI")) { const score = results[i].score; this.saveHighscoreEntry(name, score, this.modeTag); } }); results.sort((a,b) => b.score - a.score); const oldHighscore = this.stats.highscore; const myScore = results.find(r => r.name === this.players[0]).score; const isNewRecord = myScore > oldHighscore; let resultType = 'solo'; if (this.players.length > 1) { if (results[0].name === this.players[0]) resultType = 'win'; else resultType = 'loss'; } this.updateStats(myScore, resultType); this.soundMgr.win(); let title = "KRAJ IGRE"; let message = ""; if (this.players.length === 1) { if (isNewRecord) { this.confetti.start(); setTimeout(() => this.confetti.stop(), 5000); title = "üéâ NOVI REKORD! üèÜ"; message = `BRAVO! Nadma≈°ili ste sami sebe!\n\nNovi rekord: <span style="color:var(--gold-main); font-weight:bold;">${myScore}</span> poena.`; } else { title = "DOBRA PARTIJA"; message = `Osvojili ste <span style="color:var(--gold-main);">${myScore}</span> poena.\nVi≈°e sreƒáe drugi put!\nVa≈° rekord ostaje: ${oldHighscore}`; } } else { const winner = results[0]; const loser = results[results.length - 1]; title = `üèÜ POBEDNIK: ${winner.name.toUpperCase()}!`; const quotes = ["Glavu gore, kockice su varljive!", "Dobar otpor, ali protivnik je imao vi≈°e sreƒáe.", "Sledeƒái put je tvoja pobeda!", "Nije va≈æno pobediti, va≈æno je uƒçestvovati.", "Samo ve≈æbom do savr≈°enstva."]; const quote = quotes[Math.floor(Math.random() * quotes.length)]; message = `Rezultat: <span style="color:var(--success)">${winner.score}</span> vs <span style="color:var(--danger)">${loser.score}</span>\n\n${loser.name}, ${quote}`; if(this.aiMode) { if (winner.name.includes("AI")) this.triggerAiChat('win'); else this.triggerAiChat('lose'); } } await this.modal.alert(message, title); this.showMainMenu(); }
            async runAiTurn() { const aiIdx = this.currentPlayerIdx; const sheet = this.allScores[aiIdx]; if (this.brojBacanja === 0) { await this.throwDice(); setTimeout(() => this.runAiTurn(), 800); return; } const decision = this.ai.decideRoll(this.kockiceVals, this.brojBacanja, sheet); if (decision.type === 'write') { const best5 = this.getBest5(decision.row, this.kockiceVals); const pts = this.calcPoints(decision.row, best5); if (pts > 50) this.triggerAiChat('aiGood'); this.writeScore(decision.row, decision.col, aiIdx); } else if (decision.type === 'hold') { this.zadrzane = decision.hold; this.updateDiceVisuals(); await this.throwDice(); setTimeout(() => this.runAiTurn(), 800); } }
            getBest5(row, dice) { const d = [...dice]; if (row === "Min") return d.sort((a,b)=>a-b).slice(0,5); if (row === "Max") return d.sort((a,b)=>b-a).slice(0,5); if (row === "Kenta") { const u = [...new Set(d)].sort((a,b)=>a-b); if ([2,3,4,5,6].every(v=>u.includes(v))) return [2,3,4,5,6]; if ([1,2,3,4,5].every(v=>u.includes(v))) return [1,2,3,4,5]; return d.sort((a,b)=>b-a).slice(0,5); } if (row === "Ful") { const c={}; d.forEach(x=>c[x]=(c[x]||0)+1); const k=Object.keys(c).map(Number); if(k.some(x=>c[x]>=5)) return Array(5).fill(k.find(x=>c[x]>=5)); const threes=k.filter(x=>c[x]>=3); const pairs=k.filter(x=>c[x]>=2); let cands=[]; threes.forEach(t=>{pairs.forEach(p=>{if(t!==p)cands.push([...Array(3).fill(t),...Array(2).fill(p)])})}); if(cands.length>0) return cands.sort((a,b)=>sum(b)-sum(a))[0]; } if (["1","2","3","4","5","6"].includes(row)) { const t=parseInt(row); const match=d.filter(x=>x===t); const rest=d.filter(x=>x!==t).sort((a,b)=>b-a); return [...match,...rest].slice(0,5); } const c={}; d.forEach(x=>c[x]=(c[x]||0)+1); d.sort((a,b)=>{if(c[b]!==c[a])return c[b]-c[a]; return b-a}); return d.slice(0,5); }
            calcPoints(row, v) { const s = sum(v); if (["1","2","3","4","5","6"].includes(row)) return v.filter(x=>x===parseInt(row)).length * parseInt(row); if (row === "Max" || row === "Min") return s; if (row === "Triling") { const c={}; v.forEach(x=>c[x]=(c[x]||0)+1); if(Object.values(c).some(cnt=>cnt>=3)) return (3*Number(Object.keys(c).find(k=>c[k]>=3)))+20; return 0; } if (row === "Kenta") { const u=[...new Set(v)].sort((a,b)=>a-b); const k1=[1,2,3,4,5].every(x=>u.includes(x)); const k2=[2,3,4,5,6].every(x=>u.includes(x)); if(k1||k2) { if(this.brojBacanja===1) return 66; if(this.brojBacanja===2) return 56; return 46; } return 0; } if (row === "Ful") { const c={}; v.forEach(x=>c[x]=(c[x]||0)+1); if (Object.values(c).includes(5)||(Object.values(c).includes(3)&&Object.values(c).includes(2))) return s+30; return 0; } if (row === "Poker") { const c={}; v.forEach(x=>c[x]=(c[x]||0)+1); if(Object.values(c).some(cnt=>cnt>=4)) return (Number(Object.keys(c).find(k=>c[k]>=4))*4)+40; return 0; } if (row === "Yamb") { const c={}; v.forEach(x=>c[x]=(c[x]||0)+1); if(Object.values(c).some(cnt=>cnt>=5)) return (Number(Object.keys(c).find(k=>c[k]>=5))*5)+50; return 0; } return 0; }
            updateTableVisuals() { 
                this.players.forEach((p, idx) => { 
                    const data = this.allScores[idx]; 
                    let grandTotal = 0; 
                    
                    KOLONE.forEach(col => { 
                        let sum1 = 0; 
                        ["1","2","3","4","5","6"].forEach(r => { if(data[col][r]!==null) sum1 += data[col][r]; }); 
                        if(sum1 >= 60) sum1 += 30; 
                        document.getElementById(`sum-${idx}-${col}-ZBIR 1`).innerText = sum1; 
                        
                        let sum2 = 0; 
                        const vMax = data[col]["Max"]; const vMin = data[col]["Min"]; const v1 = data[col]["1"]; 
                        if (vMax!==null && vMin!==null && v1!==null) { 
                            sum2 = (vMax - vMin) * v1; 
                            if (sum2 >= 60) sum2 += 40; 
                        } 
                        document.getElementById(`sum-${idx}-${col}-ZBIR 2`).innerText = sum2; 
                        
                        let sum3 = 0; 
                        ["Triling","Kenta","Ful","Poker","Yamb"].forEach(r => { if(data[col][r]!==null) sum3 += data[col][r]; }); 
                        document.getElementById(`sum-${idx}-${col}-ZBIR 3`).innerText = sum3; 
                        
                        grandTotal += sum1 + sum2 + sum3; 
                        
                        REDOVI_PRIKAZ.forEach(row => { 
                            const btn = document.getElementById(`btn-${idx}-${col}-${row}`); 
                            if (!btn) return; 
                            
                            const val = data[col][row]; 
                            btn.classList.remove('highlight-najava'); 
                            
                            if (val !== null) { 
                                btn.innerText = val; 
                                btn.classList.add('filled'); 
                                btn.disabled = true; 
                            } else { 
                                btn.innerText = ""; 
                                btn.classList.remove('filled'); 
                                
                                const isMyTurnOnline = (this.onlineMode && this.currentPlayerIdx === this.myOnlineIndex && idx === this.myOnlineIndex); 
                                const isLocalTurn = (!this.onlineMode && idx === this.currentPlayerIdx && !this.players[idx].includes("AI")); 
                                
                                if ((isMyTurnOnline || isLocalTurn) && this.brojBacanja > 0) {
                                    btn.disabled = false;
                                } else {
                                    btn.disabled = true;
                                }
                                
                                if (this.najavljenoPolje && this.najavljenoPolje.row === row && this.najavljenoPolje.col === col) {
                                    btn.classList.add('highlight-najava'); 
                                }
                            } 
                        }); 
                    }); 
                    document.getElementById(`total-${idx}`).innerText = grandTotal; 
                }); 
            }
            updateHighscoresUI() { }
            checkSavedGame() { const saved = localStorage.getItem('yamb_saved_game'); const btnResume = document.getElementById('btn-resume-game'); if (saved) { btnResume.classList.remove('hidden'); } else { btnResume.classList.add('hidden'); } }
            autoSaveGame() { if(this.onlineMode) return; const data = { players: this.players, scores: this.allScores, current: this.currentPlayerIdx, aiMode: this.aiMode, diff: this.aiDifficulty, date: new Date().toISOString() }; localStorage.setItem('yamb_saved_game', JSON.stringify(data)); }
            async saveGame() { this.autoSaveGame(); const isNative = window.Capacitor && window.Capacitor.isNative; if (!isNative) { const jsonString = JSON.stringify(JSON.parse(localStorage.getItem('yamb_saved_game'))); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "yamb_save.json"; a.click(); this.modal.alert("Igra je saƒçuvana u pretra≈æivaƒçu i kao fajl!"); } else { this.modal.alert("Igra je uspe≈°no saƒçuvana!", "SAƒåUVANO"); } this.checkSavedGame(); }
            
            // --- ISPRAVLJEN LOAD SAVE GAME (PREVENCIJA CRASH-A) ---
            async loadSavedGame() { 
                try { 
                    const saved = localStorage.getItem('yamb_saved_game'); 
                    if (!saved) { this.modal.alert("Nema saƒçuvane igre."); return; } 
                    
                    const data = JSON.parse(saved); 
                    
                    // --- MIGRACIJA PODATAKA (POPRAVKA ZA STARE SAVE-OVE) ---
                    // Ako u starom save-u fale nove kolone (npr. Nagore), dodaj ih prazne
                    KOLONE.forEach(col => {
                        this.players.forEach((_, idx) => {
                             // Provera za svakog igraƒça
                             if (data.scores[idx] && !data.scores[idx][col]) {
                                data.scores[idx][col] = {};
                                REDOVI_IGRA.forEach(r => data.scores[idx][col][r] = null);
                            }
                        });
                    });
                    // -------------------------------------------------------

                    this.players = data.players; 
                    this.allScores = data.scores; 
                    this.currentPlayerIdx = data.current; 
                    this.aiMode = data.aiMode; 
                    this.aiDifficulty = data.diff || "medium"; 
                    
                    if (this.aiMode) this.ai = new YambAI(this, this.aiDifficulty); 
                    
                    this.startGame(); 
                    this.highlightCurrentPlayer(); 
                    this.updateTableVisuals(); 
                    this.modal.alert("Igra nastavljena!"); 
                } catch (e) { 
                    console.error(e); 
                    this.modal.alert("Gre≈°ka pri uƒçitavanju igre.\nFormat podataka je zastareo."); 
                    localStorage.removeItem('yamb_saved_game');
                } 
            }

            async loadGameFromFile() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = ev => { try { const data = JSON.parse(ev.target.result); this.players = data.players; this.allScores = data.scores; this.currentPlayerIdx = data.current; this.aiMode = data.aiMode; this.aiDifficulty = data.diff || "medium"; if (this.aiMode) this.ai = new YambAI(this, this.aiDifficulty); this.startGame(); this.highlightCurrentPlayer(); this.updateTableVisuals(); this.modal.alert("Igra uspe≈°no uƒçitana iz fajla!"); this.autoSaveGame(); } catch (err) { this.modal.alert("Gre≈°ka pri uƒçitavanju fajla!"); } }; reader.readAsText(file); }; input.click(); }
        }

        const app = new YambApp();
    </script>
</body>
</html>